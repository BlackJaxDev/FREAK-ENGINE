using Silk.NET.Maths;
using Silk.NET.Vulkan;
using System.Runtime.CompilerServices;
using XREngine.Data;
using Buffer = Silk.NET.Vulkan.Buffer;

public unsafe partial class VulkanAPI : BaseAPI
{
    private Buffer[]? uniformBuffers;
    private DeviceMemory[]? uniformBuffersMemory;

    struct UniformBufferObject
    {
        public Matrix4X4<float> model;
        public Matrix4X4<float> view;
        public Matrix4X4<float> proj;
    }

    private void DestroyUniformBuffers()
    {
        for (int i = 0; i < swapChainImages!.Length; i++)
        {
            vk!.DestroyBuffer(device, uniformBuffers![i], null);
            vk!.FreeMemory(device, uniformBuffersMemory![i], null);
        }
    }

    private void CreateUniformBuffers()
    {
        ulong bufferSize = (ulong)Unsafe.SizeOf<UniformBufferObject>();

        uniformBuffers = new Buffer[swapChainImages!.Length];
        uniformBuffersMemory = new DeviceMemory[swapChainImages!.Length];

        for (int i = 0; i < swapChainImages.Length; i++)
            CreateBuffer(bufferSize, BufferUsageFlags.UniformBufferBit, MemoryPropertyFlags.HostVisibleBit | MemoryPropertyFlags.HostCoherentBit, ref uniformBuffers[i], ref uniformBuffersMemory[i]);
    }

    private void SubmitUniformBuffers(uint currentImage)
    {
        var time = (float)window!.Time;

        UniformBufferObject ubo = new()
        {
            model = Matrix4X4<float>.Identity * Matrix4X4.CreateFromAxisAngle<float>(new Vector3D<float>(0, 0, 1), time * Radians(90.0f)),
            view = Matrix4X4.CreateLookAt(new Vector3D<float>(2, 2, 2), new Vector3D<float>(0, 0, 0), new Vector3D<float>(0, 0, 1)),
            proj = Matrix4X4.CreatePerspectiveFieldOfView(XMath.DegToRad(45.0f), (float)swapChainExtent.Width / swapChainExtent.Height, 0.1f, 10.0f),
        };
        ubo.proj.M22 *= -1;

        void* data;
        vk!.MapMemory(device, uniformBuffersMemory![currentImage], 0, (ulong)Unsafe.SizeOf<UniformBufferObject>(), 0, &data);
        new Span<UniformBufferObject>(data, 1)[0] = ubo;
        vk!.UnmapMemory(device, uniformBuffersMemory![currentImage]);
    }
}